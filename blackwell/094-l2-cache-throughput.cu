/*
    B200 Results:
        L2 Size=126.50 MB
        ==================================
        N=2048, REPEAT=128
        Size: 8 MB
        Time: 51.68 us
        Throughput: 20774.81 GB/s
        ==================================
        N=3072, REPEAT=128
        Size: 18 MB
        Time: 120.34 us
        Throughput: 20076.07 GB/s
        ==================================
        N=4096, REPEAT=128
        Size: 32 MB
        Time: 210.49 us
        Throughput: 20404.87 GB/s
        ==================================
        N=4224, REPEAT=128
        Size: 34 MB
        Time: 223.26 us
        Throughput: 20458.84 GB/s
        ==================================
        N=4352, REPEAT=128
        Size: 36 MB
        Time: 236.74 us
        Throughput: 20480.86 GB/s
        ==================================
        N=4480, REPEAT=128
        Size: 38 MB
        Time: 250.19 us
        Throughput: 20536.13 GB/s
        ==================================
        N=4608, REPEAT=128
        Size: 40 MB
        Time: 266.17 us
        Throughput: 20422.36 GB/s
        ==================================
        N=4736, REPEAT=128
        Size: 43 MB
        Time: 279.37 us
        Throughput: 20553.50 GB/s
        ==================================
        N=4864, REPEAT=128
        Size: 45 MB
        Time: 294.98 us
        Throughput: 20532.41 GB/s
        ==================================
        N=4992, REPEAT=128
        Size: 48 MB
        Time: 310.87 us
        Throughput: 20521.45 GB/s
        ==================================
        N=5120, REPEAT=128
        Size: 50 MB
        Time: 327.62 us
        Throughput: 20484.06 GB/s
        ==================================
        N=5248, REPEAT=128
        Size: 53 MB
        Time: 344.17 us
        Throughput: 20485.90 GB/s
        ==================================
        N=5376, REPEAT=128
        Size: 55 MB
        Time: 360.77 us
        Throughput: 20508.27 GB/s
        ==================================
        N=5504, REPEAT=128
        Size: 58 MB
        Time: 376.68 us
        Throughput: 20588.39 GB/s
        ==================================
        N=5632, REPEAT=128
        Size: 60 MB
        Time: 395.14 us
        Throughput: 20550.01 GB/s
        ==================================
        N=5760, REPEAT=128
        Size: 63 MB
        Time: 417.64 us
        Throughput: 20336.78 GB/s
        ==================================
        N=5888, REPEAT=128
        Size: 66 MB
        Time: 436.40 us
        Throughput: 20337.30 GB/s
        ==================================
        N=6016, REPEAT=128
        Size: 69 MB
        Time: 455.17 us
        Throughput: 20355.34 GB/s
        ==================================
        N=6144, REPEAT=128
        Size: 72 MB
        Time: 475.06 us
        Throughput: 20341.86 GB/s
        ==================================
        N=6272, REPEAT=128
        Size: 75 MB
        Time: 494.26 us
        Throughput: 20374.96 GB/s
        ==================================
        N=6400, REPEAT=128
        Size: 78 MB
        Time: 519.78 us
        Throughput: 20173.30 GB/s
        ==================================
        N=6528, REPEAT=128
        Size: 81 MB
        Time: 562.44 us
        Throughput: 19396.67 GB/s
        ==================================
        N=6656, REPEAT=128
        Size: 84 MB
        Time: 645.87 us
        Throughput: 17559.75 GB/s
        ==================================
        N=6784, REPEAT=128
        Size: 88 MB
        Time: 819.55 us
        Throughput: 14375.89 GB/s
        ==================================
        N=6912, REPEAT=128
        Size: 91 MB
        Time: 1017.97 us
        Throughput: 12014.71 GB/s
        ==================================
        N=7040, REPEAT=128
        Size: 95 MB
        Time: 1105.73 us
        Throughput: 11474.61 GB/s
        ==================================
        N=7168, REPEAT=128
        Size: 98 MB
        Time: 1377.31 us
        Throughput: 9550.01 GB/s
        ==================================
        N=7296, REPEAT=128
        Size: 102 MB
        Time: 1605.49 us
        Throughput: 8487.95 GB/s
        ==================================
        N=7424, REPEAT=128
        Size: 105 MB
        Time: 1773.83 us
        Throughput: 7954.35 GB/s
        ==================================
        N=7552, REPEAT=128
        Size: 109 MB
        Time: 1876.85 us
        Throughput: 7779.18 GB/s
        ==================================
        N=7680, REPEAT=128
        Size: 112 MB
        Time: 1975.51 us
        Throughput: 7643.32 GB/s
        ==================================
        N=7808, REPEAT=128
        Size: 116 MB
        Time: 2062.48 us
        Throughput: 7567.09 GB/s
        ==================================
        N=7936, REPEAT=128
        Size: 120 MB
        Time: 2152.84 us
        Throughput: 7489.14 GB/s
        ==================================
        N=8064, REPEAT=128
        Size: 124 MB
        Time: 2239.03 us
        Throughput: 7434.99 GB/s
        ==================================
        N=8192, REPEAT=128
        Size: 128 MB
        Time: 2316.82 us
        Throughput: 7415.28 GB/s
        ==================================
        N=16384, REPEAT=128
        Size: 512 MB
        Time: 9123.11 us
        Throughput: 7532.46 GB/s

    H100 Results:
        L2 Size=50.00 MB
        ==================================
        N=2048, REPEAT=128
        Size: 8 MB
        Time: 129.44 us
        Throughput: 8295.00 GB/s
        ==================================
        N=3072, REPEAT=128
        Size: 18 MB
        Time: 293.45 us
        Throughput: 8232.88 GB/s
        ==================================
        N=4096, REPEAT=128
        Size: 32 MB
        Time: 522.99 us
        Throughput: 8212.35 GB/s
        ==================================
        N=4224, REPEAT=128
        Size: 34 MB
        Time: 558.38 us
        Throughput: 8180.07 GB/s
        ==================================
        N=4352, REPEAT=128
        Size: 36 MB
        Time: 694.72 us
        Throughput: 6979.29 GB/s
        ==================================
        N=4480, REPEAT=128
        Size: 38 MB
        Time: 885.66 us
        Throughput: 5801.35 GB/s
        ==================================
        N=4608, REPEAT=128
        Size: 40 MB
        Time: 1165.06 us
        Throughput: 4665.71 GB/s
        ==================================
        N=4736, REPEAT=128
        Size: 43 MB
        Time: 1409.46 us
        Throughput: 4073.90 GB/s
        ==================================
        N=4864, REPEAT=128
        Size: 45 MB
        Time: 1653.47 us
        Throughput: 3662.96 GB/s
        ==================================
        N=4992, REPEAT=128
        Size: 48 MB
        Time: 1849.94 us
        Throughput: 3448.52 GB/s
        ==================================
        N=5120, REPEAT=128
        Size: 50 MB
        Time: 2003.95 us
        Throughput: 3348.83 GB/s
        ==================================
        N=5248, REPEAT=128
        Size: 53 MB
        Time: 2138.40 us
        Throughput: 3297.16 GB/s
        ==================================
        N=5376, REPEAT=128
        Size: 55 MB
        Time: 2262.40 us
        Throughput: 3270.31 GB/s
        ==================================
        N=5504, REPEAT=128
        Size: 58 MB
        Time: 2384.03 us
        Throughput: 3253.01 GB/s
        ==================================
        N=5632, REPEAT=128
        Size: 60 MB
        Time: 2501.49 us
        Throughput: 3246.14 GB/s
        ==================================
        N=5760, REPEAT=128
        Size: 63 MB
        Time: 2618.36 us
        Throughput: 3243.81 GB/s
        ==================================
        N=5888, REPEAT=128
        Size: 66 MB
        Time: 2737.84 us
        Throughput: 3241.66 GB/s
        ==================================
        N=6016, REPEAT=128
        Size: 69 MB
        Time: 2859.33 us
        Throughput: 3240.35 GB/s
        ==================================
        N=6144, REPEAT=128
        Size: 72 MB
        Time: 2982.31 us
        Throughput: 3240.33 GB/s
        ==================================
        N=6272, REPEAT=128
        Size: 75 MB
        Time: 3107.47 us
        Throughput: 3240.75 GB/s
        ==================================
        N=6400, REPEAT=128
        Size: 78 MB
        Time: 3235.84 us
        Throughput: 3240.51 GB/s
        ==================================
        N=6528, REPEAT=128
        Size: 81 MB
        Time: 3368.47 us
        Throughput: 3238.68 GB/s
        ==================================
        N=6656, REPEAT=128
        Size: 84 MB
        Time: 3499.22 us
        Throughput: 3241.12 GB/s
        ==================================
        N=6784, REPEAT=128
        Size: 88 MB
        Time: 3635.61 us
        Throughput: 3240.66 GB/s
        ==================================
        N=6912, REPEAT=128
        Size: 91 MB
        Time: 3773.76 us
        Throughput: 3240.96 GB/s
        ==================================
        N=7040, REPEAT=128
        Size: 95 MB
        Time: 3914.54 us
        Throughput: 3241.19 GB/s
        ==================================
        N=7168, REPEAT=128
        Size: 98 MB
        Time: 4058.29 us
        Throughput: 3241.10 GB/s
        ==================================
        N=7296, REPEAT=128
        Size: 102 MB
        Time: 4204.19 us
        Throughput: 3241.36 GB/s
        ==================================
        N=7424, REPEAT=128
        Size: 105 MB
        Time: 4352.60 us
        Throughput: 3241.66 GB/s
        ==================================
        N=7552, REPEAT=128
        Size: 109 MB
        Time: 4502.56 us
        Throughput: 3242.68 GB/s
        ==================================
        N=7680, REPEAT=128
        Size: 112 MB
        Time: 4658.86 us
        Throughput: 3241.03 GB/s
        ==================================
        N=7808, REPEAT=128
        Size: 116 MB
        Time: 4812.88 us
        Throughput: 3242.75 GB/s
        ==================================
        N=7936, REPEAT=128
        Size: 120 MB
        Time: 4974.21 us
        Throughput: 3241.30 GB/s
        ==================================
        N=8064, REPEAT=128
        Size: 124 MB
        Time: 5135.55 us
        Throughput: 3241.56 GB/s
        ==================================
        N=8192, REPEAT=128
        Size: 128 MB
        Time: 5298.08 us
        Throughput: 3242.66 GB/s
        ==================================
        N=16384, REPEAT=128
        Size: 512 MB
        Time: 21171.99 us
        Throughput: 3245.77 GB/s
*/

#include <random>
#include <vector>

#include "kittens.cuh"

using namespace kittens;

template <int _N, int _REPEAT, int _TILE_N=128>
struct globals {
    static constexpr int N = _N;
    static constexpr int REPEAT = _REPEAT;
    static constexpr int TILE_N = _TILE_N;

    using tile = st_bf<TILE_N, TILE_N>;
    using a_gl = gl<bf16, 1, 1, N, N, tile>;
    using b_gl = gl<bf16, 1, 1, N, N, tile>;

    a_gl a;
    b_gl b;

    __host__ dim3 grid() { return dim3(N / TILE_N, N / TILE_N, REPEAT); }
    __host__ dim3 block() { return dim3(1); }
    __host__ int dynamic_shared_memory() { return TILE_N * TILE_N * sizeof(bf16) + 1024; }
};

template <typename globals_t>
__global__ void kernel(const __grid_constant__ globals_t g) {
    extern __shared__ int __shm[]; 
    tma_swizzle_allocator al((int*)&__shm[0]);
    auto &tile = al.allocate<typename globals_t::tile>();

    __shared__ semaphore inputs_arrived;
    init_semaphore(inputs_arrived, 0, 1);

    const int row = blockIdx.y;
    const int col = blockIdx.x;

    // No need to wait as kernel will flush before exit
    tma::load_async(tile, g.a, {row, col}, inputs_arrived);
}

template <typename globals_t>
void run() {
    constexpr int N = globals_t::N;
    constexpr int REPEAT = globals_t::REPEAT;
    constexpr int SIZE = N * N * sizeof(bf16);

    printf("==================================\n");
    printf("N=%d, REPEAT=%d\n", N, REPEAT);
    printf("Size: %.0f MB\n", SIZE / 1024. / 1024.);

    // Sleep for 50 ms to limit power consumption and thermals
    usleep(50000);

    std::random_device rd;
    std::mt19937 gen(42);
    std::uniform_real_distribution<> dis(-1.0, 1.0);

    std::vector<bf16> h_A(N * N);
    for (int i = 0; i < N * N; ++i) h_A[i] = __float2bfloat16(dis(gen));

    bf16 *d_A, *d_B;
    CUDACHECK(cudaMalloc(&d_A, SIZE));
    CUDACHECK(cudaMalloc(&d_B, SIZE));
    CUDACHECK(cudaMemcpy(d_A, h_A.data(), SIZE, cudaMemcpyHostToDevice));

    typename globals_t::a_gl a_gl{d_A, nullptr, nullptr, nullptr, nullptr};
    typename globals_t::b_gl b_gl{d_B, nullptr, nullptr, nullptr, nullptr};
    globals_t g{a_gl, b_gl};

    constexpr int num_warmups = 500;
    constexpr int num_iters = 100;
    cudaFuncSetAttribute(kernel<globals_t>, cudaFuncAttributeMaxDynamicSharedMemorySize, g.dynamic_shared_memory());

    for(int i = 0; i < num_warmups; i++)
        kernel<globals_t><<<g.grid(), g.block(), g.dynamic_shared_memory()>>>(g);

    cudaEvent_t start, stop;
    CUDACHECK(cudaEventCreate(&start));
    CUDACHECK(cudaEventCreate(&stop));
    CUDACHECK(cudaDeviceSynchronize());
    CUDACHECK(cudaEventRecord(start));
    for(int i = 0; i < num_iters; i++)
        kernel<globals_t><<<g.grid(), g.block(), g.dynamic_shared_memory()>>>(g);
    CUDACHECK(cudaEventRecord(stop));
    CUDACHECK(cudaEventSynchronize(stop));

    float milliseconds;
    cudaEventElapsedTime(&milliseconds, start, stop);
    double avg_time = double(milliseconds) / 1000.0 / num_iters;
    double bps = double(REPEAT) * SIZE / avg_time;
    printf("Time: %.2f us\n", avg_time * 1e6);
    printf("Throughput: %.2f GB/s\n", bps / 1e9);

    cudaFree(d_A);
    cudaFree(d_B);
    cudaEventDestroy(start);
    cudaEventDestroy(stop);
}

int main() {
    int device_id;
    CUDACHECK(cudaGetDevice(&device_id));
    cudaDeviceProp prop;
    CUDACHECK(cudaGetDeviceProperties(&prop, device_id));
    printf("L2 Size=%.2f MB\n", (double)prop.l2CacheSize / 1024 / 1024);

    run<globals<2048, 128, 128>>();
    run<globals<3072, 128, 128>>();
    run<globals<4096, 128, 128>>();
    run<globals<4224, 128, 128>>();
    run<globals<4352, 128, 128>>();
    run<globals<4480, 128, 128>>();
    run<globals<4608, 128, 128>>();
    run<globals<4736, 128, 128>>();
    run<globals<4864, 128, 128>>();
    run<globals<4992, 128, 128>>();
    run<globals<5120, 128, 128>>();
    run<globals<5248, 128, 128>>();
    run<globals<5376, 128, 128>>();
    run<globals<5504, 128, 128>>();
    run<globals<5632, 128, 128>>();
    run<globals<5760, 128, 128>>();
    run<globals<5888, 128, 128>>();
    run<globals<6016, 128, 128>>();
    run<globals<6144, 128, 128>>();
    run<globals<6272, 128, 128>>();
    run<globals<6400, 128, 128>>();
    run<globals<6528, 128, 128>>();
    run<globals<6656, 128, 128>>();
    run<globals<6784, 128, 128>>();
    run<globals<6912, 128, 128>>();
    run<globals<7040, 128, 128>>();
    run<globals<7168, 128, 128>>();
    run<globals<7296, 128, 128>>();
    run<globals<7424, 128, 128>>();
    run<globals<7552, 128, 128>>();
    run<globals<7680, 128, 128>>();
    run<globals<7808, 128, 128>>();
    run<globals<7936, 128, 128>>();
    run<globals<8064, 128, 128>>();
    run<globals<8192, 128, 128>>();
    run<globals<16384, 128, 128>>();
}
